#!/bin/bash
# ==============================================================================
# Video Tools 2.0
# Copyright (C) 2025 CeleroLab
#
# Description: Main entry point script for Video Tools.
# Author: CeleroLab
# License: MIT
# ==============================================================================

SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
PROJECT_ROOT="$(dirname "$DIR")"

export LANG=C.UTF-8
export LC_ALL=C.UTF-8

unset LD_LIBRARY_PATH

source "$PROJECT_ROOT/lib/core.sh"
source "$PROJECT_ROOT/lib/utils.sh"

detect_environment

MODULES_DIR="$PROJECT_ROOT/modules"
MODULE_FILES=()
MODULE_NAMES=()
MODULE_DESCS=()

i=0
for f in "$MODULES_DIR"/*.sh; do
  if [ -f "$f" ]; then

    MODULE_NAME=""
    MODULE_DESCRIPTION=""
    
    name=$(grep 'MODULE_NAME=' "$f" | cut -d'"' -f2)
    desc=$(grep 'MODULE_DESCRIPTION=' "$f" | cut -d'"' -f2)
    
    if [ -n "$name" ]; then
        MODULE_FILES[$i]="$f"
        MODULE_NAMES[$i]="$name"
        MODULE_DESCS[$i]="$desc"
        ((i++))
    fi
  fi
done

function show_usage() {
  echo -e "${BLUE}Video Tools 2.0${NC}"
  echo "A modular command-line toolkit for video manipulation."
  echo ""
  echo "Usage: video-tools [OPTIONS]"
  echo ""
  echo "Options:"
  echo "  -h, --help    Show this help message and exit."
  echo ""
  echo "Available Modules (run without arguments to see interactive menu):"
  for ((j=0; j<${#MODULE_NAMES[@]}; j++)); do
    echo "  - ${MODULE_NAMES[$j]}"
  done
  echo ""
  echo "To use a specific module in headless mode, execute it directly from the modules/ folder."
  echo "Example: ./modules/remove_audio.sh -i input.mp4"
}

# Parse top-level arguments
if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  show_usage
  exit 0
fi

function show_menu() {
  echo -e "\n${BLUE}=== Video Tools (${ENVIRONMENT}) ===${NC}"
  for ((j=0; j<${#MODULE_NAMES[@]}; j++)); do
    echo -e "${GREEN}$((j+1)))${NC} ${MODULE_NAMES[$j]} - ${MODULE_DESCS[$j]}"
  done
  echo -e "${GREEN}$(( ${#MODULE_NAMES[@]} + 1 )))${NC} Exit"
}

while true; do
  show_menu
  read -rp "Option: " option
  
  if [[ "$option" =~ ^[0-9]+$ ]]; then
      if [ "$option" -le "${#MODULE_NAMES[@]}" ] && [ "$option" -gt 0 ]; then
          idx=$((option-1))
          script="${MODULE_FILES[$idx]}"
          
          (
            source "$script"
            module_run
          )
          
      elif [ "$option" -eq "$(( ${#MODULE_NAMES[@]} + 1 ))" ]; then
          echo "Exiting..."
          exit 0
      else
          log_error "Invalid option"
      fi
  else
      log_error "Please enter a number."
  fi
  echo "-------------------------------"
done
